<script type="text/x-red" data-template-name="german-holidays">
    <div>
        <label for="node-input-holiday-container-row"><i class="fa fa-list"></i> <span data-i18n="german-holidays.label.holidayList"></span></label>
        <div class="form-row node-input-holiday-container-row">
            <ol id="node-input-holiday-container"></ol>
        </div>
        <button type="button" id="node-button-clearHolidays" class="ui-button ui-widget ui-corner-all"><i class="fa fa-minus-square"></i> <span data-i18n="german-holidays.label.clearHolidayBtn"></span></button>
        <br>
    </div>

    <div class="form-row" data-i18n="[title]german-holidays.placeholder.region">
        <label for="node-regionSel"><i class="fa fa-globe"></i> <span data-i18n="german-holidays.label.addpreDefined"></span></label>
        <select type="text" id="node-regionSel">
            <option value="ALL" >alle</option>
            <option value="BUND" >allgemeine</option>
            <option value="BW" >Baden-Württemberg</option>
            <option value="BY" >Bayern</option>
            <option value="BE" >Berlin</option>
            <option value="BB" >Brandenburg</option>
            <option value="HB" >Bremen</option>
            <option value="HH" >Hamburg</option>
            <option value="HE" >Hessen</option>
            <option value="MV" >Mecklenburg-Vorpommern</option>
            <option value="NI" >Niedersachsen</option>
            <option value="NW" >Nordrhein-Westfalen</option>
            <option value="RP" >Rheinland-Pfalz</option>
            <option value="SL" >Saarland</option>
            <option value="SN" >Sachsen</option>
            <option value="ST" >Sachsen-Anhalt</option>
            <option value="SH" >Schleswig-Holstein</option>
            <option value="TH" >Thüringen</option>
        </select>
        <input type="hidden" id="node-input-region">
        <button type="button" id="node-button-addHolidays" class="ui-button ui-widget ui-corner-all"><i class="fa fa-plus-square"></i> </button>
    </div>

    <div class="form-tips" data-i18n="[html]german-holidays.tips.holiday"></div>

    <hr>
    <div>
        <label for="node-input-specialday-container-row"><i class="fa fa-list"></i> <span data-i18n="german-holidays.label.specialdayList"></span></label>
        <div class="form-row node-input-specialday-container-row">
            <ol id="node-input-specialday-container"></ol>
        </div>
        <button type="button" id="node-button-clearSpecialDays" class="ui-button ui-widget ui-corner-all"><i class="fa fa-minus-circle"></i> <span data-i18n="german-holidays.label.clearSpecialdayBtn"></span></button>
        <br>
    </div>

    <div class="form-row">
        <label for="node-button-addSpecialDays"><i class="fa fa-plus-circle"></i><span data-i18n="german-holidays.label.addpreDefined2"></span></label>
        <button type="button" id="node-button-addSpecialDays" class="ui-button ui-widget ui-corner-all"><i class="fa fa-plus-circle"></i> <span data-i18n="german-holidays.label.addSpecialdayBtn"></span></button>
    </div>

    <div class="form-tips" data-i18n="[html]german-holidays.tips.specialday"></div>

    <hr>
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]node-red:common.label.topic">
    </div>
    <div class="form-row" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]time-span.placeholder.name">
    </div>

    <div id="dialog-edit-day" title="Add to List" class="red-ui-editor">
        <div class="form-row">
            <label for="name">ID</label>
            <input type="text" name="dialog-input-id" id="dialog-input-id" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="name">Name</label>
            <input type="text" name="dialog-input-name" id="dialog-input-name" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="name">Alternativer Name</label>
            <input type="text" name="dialog-input-nameAlt" id="dialog-input-nameAlt" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="name">Typ</label>
            <select type="text" id="dialog-input-typ" name="dialog-input-typ" >
                    <option value="date" >Datum</option>
                    <option value="easter" >relativ zu Ostern</option>
                    <option value="advent" >relativ zum 4. Advent</option>
                    <option value="weekday" >relativer Wochentag im Monat</option>
            </select>
        </div>

        <div class="form-row dialog-input-date-row">
            <label for="name">Datum</label>
            <input type="text" name="dialog-input-date" id="dialog-input-date" min="1" max="31" step="1" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row dialog-input-daysRel-row">
            <label for="name">relative Days</label>
            <input type="number" name="dialog-input-daysRel" id="dialog-input-daysRel" min="-370" max="370" step="1" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row dialog-input-month-row">
            <label for="name">Month</label>
            <select type="text" id="dialog-input-month" name="dialog-input-month" class="text ui-widget-content ui-corner-all" >
            </select>
        </div>
        <div class="form-row dialog-input-offset-row">
            <label for="name">offset</label>
            <input type="number" name="dialog-input-offset" id="dialog-input-offset" min="1" max="31" step="1" class="text ui-widget-content ui-corner-all">
        </div>
    </div>
</script>


<!-- Next, some simple help text is provided for the node. -->
<script type="text/x-red" data-help-name="german-holidays">
    <body>
    <h3>About</h3>
    <p>Gets german holidays</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">any</span>
        </dt>
        <dd> the payload is not used. </dd>

        <dt>region <span class="property-type">region</span></dt>
        <dd> the region which should be used for getting holidays. Could also be defined in the configuration of the node. This property must be a string of two letters with the german state shortcut (BY=Bayern, BE=Berlin, ...).</dd>

        <dt class="optional">ts <span class="property-type">number</span></dt>
        <dd> defines a timestamp for the source of the data. if not defined today will be used.</dd>

        <dt class="optional">day <span class="property-type">number</span></dt>
        <dd> if defined only the Holiday information will get the relative to the timestamp (today by default). So if `msg.ts` is not defined, `msg.day = 0` is today, `msg.day = -1` is yesterday; `msg.day = 1` is tomorow, ...</dd>

        <dt class="optional">date <span class="property-type">Date</span></dt>
        <dd> if defined only the Holiday information for the defined date will given.</dd>
    </dl>

 <h3>Outputs</h3>
     <ol class="node-ports">
         <li>Standard output
             <dl class="message-properties">
                 <dt>payload <span class="property-type">object</span></dt>
                 <dd>if no `day` or `date` parameter is given, with a lot of holiday information</dd>
             </dl>
         </li>
     </ol>
     <h3>payload output properties</h3>
     <h4>day-object</h4>
     <p>if the input property day or date was set, the payload is only a day object with the following properties. Otherwhise the payload is a more complex object for different days which are of type day-object (see below).</p>
     <dl class="message-properties">
            <dt>id <span class="property-type">string</span></dt>
            <dd> an id of the object (is the english name in upper case)</dd>

            <dt>name <span class="property-type">number</span></dt>
            <dd> name of the day (in german).</dd>

            <dt>dayOfWeek <span class="property-type">number</span></dt>
            <dd> the day of the week, where 1 is monday.</dd>

            <dt>day <span class="property-type">number</span></dt>
            <dd> the day in month of the day</dd>

            <dt>month <span class="property-type">number</span></dt>
            <dd> the month of the day.</dd>

            <dt>year <span class="property-type">number</span></dt>
            <dd> the year of the day.</dd>

            <dt>date <span class="property-type">number</span></dt>
            <dd> the day as javascript date.</dd>

            <dt>dateString <span class="property-type">string</span></dt>
            <dd> the date of the day as string.</dd>

            <dt class="optional">dayOffset <span class="property-type">string</span></dt>
            <dd> the offset to today in days (not every time available).</dd>

            <dt>isSaturday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is saturday.</dd>

            <dt>isSunday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday.</dd>

            <dt>isHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is an holiday.</dd>

            <dt>isWeekend <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday or saturday.</dd>

            <dt>isSunOrHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday or a holiday.</dd>

            <dt>isWeekendOrHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday, saturday or a holiday.</dd>

            <dt class="optional">isBetweenSundayAndHoliday <span class="property-type">string</span></dt>
            <dd> is true if the day is a monday when tuseday is a holiday (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>

            <dt class="optional">isBetweenHolidayAndSaturday <span class="property-type">string</span></dt>
            <dd> is true if the day is a fridey when thursday is a holiday  (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>

            <dt class="optional">isBetweenWeekendOrHoliday <span class="property-type">string</span></dt>
            <dd> is true if the day is not a saturday, sunday or a holiday, but the day before or after is saturday, sunday or a holiday  (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>
        </dl>
        <h4>payload properties (default)</h4>
            <p>If the input has no day or date property the the payload is an object with the following properties:</p>
            <dl class="message-properties">
             <dt>yesterday <span class="property-type">day-object</span></dt>
             <dd> day-object for the day before today.</dd>

             <dt>today <span class="property-type">day-object</span></dt>
             <dd> day-object for today.</dd>

             <dt>tomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 1 day in the future from today.</dd>

             <dt>dayAfterTomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 2 days in the future from today.</dd>

             <dt>afterTheDayAfterTomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 3 days in the future from today.</dd>

             <dt>next <span class="property-type">object</span></dt>
             <dd> object representing information about the next holiday.</dd>

             <dt>next.holliday <span class="property-type">day-object</span></dt>
             <dd> object representing the next holiday.</dd>

             <dt>next.hollidayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next holiday.</dd>

             <dt>next.weekendDay <span class="property-type">day-object</span></dt>
             <dd> object representing the next saturday or sunday (if it is saturday).</dd>

             <dt>next.weekendDayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next saturday or sunday (if it is saturday).</dd>

             <dt>next.weekendOrHoliday <span class="property-type">day-object</span></dt>
             <dd> object representing the next holiday or saturday or sunday (next free day).</dd>

             <dt>next.weekendOrHolidayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next holiday or saturday or sunday (next free day).</dd>

             <dt>hollidays <span class="property-type">day-object</span></dt>
             <dd> An array of objects for every Holiday in the year.</dd>

             <dt>hollidays <span class="property-type">array</span></dt>
             <dd> An array of objects for every Holiday in the year.</dd>

             <dt>hollidaysNum <span class="property-type">array</span></dt>
             <dd> An array of numbers for every Holiday in the year.</dd>

             <dt>weekNumber <span class="property-type">number</span></dt>
             <dd> weekNumber for today.</dd>

             <dt>weekNumberEven <span class="property-type">boolean</span></dt>
             <dd> true if the weekNumber is even.</dd>
         </dl>
     <h3>Details</h3>
     <p>tbd</p>
     <h3>References</h3>
    <ul>
        <li><a href="https://github.com/Hypnos3/node-red-contrib-german-holidays">GitHub</a> - the nodes github repository</li>
    </ul>
</body>
</script>

<!-- Finally, the node type is registered along with all of its properties   -->
<!-- The example below shows a small subset of the properties that can be set-->
<script type="text/javascript">
    const allRegions = [
        'BW',
        'BY',
        'BE',
        'BB',
        'HB',
        'HE',
        'HH',
        'MV',
        'NI',
        'NW',
        'RP',
        'SL',
        'SN',
        'ST',
        'SH',
        'TH',
        'BUND',
        'ALL'
    ];

    const easterX = -1;
    const adventX = -2;

    const allDaysDefinition = {
        NEUJAHRSTAG: {
            nameDE: 'Neujahrstag', // 1.1.
            month: 1,
            day: 1,
            regions: allRegions
        },
        HEILIGEDREIKOENIGE: {
            nameDE: 'Heilige Drei Könige', // 6.1.
            nameAlt: 'Epiphanias',
            month: 1,
            day: 6,
            regions: ['BW', 'BY', 'ST', 'ALL']
        },
        VALENTINSTAG: {
            nameDE: 'Valentinstag', // 14. 2.
            month: 2,
            day: 14,
            regions: []
        },
        SCHMUDONN: {
            nameDE: 'Schmutziger Donnerstag', // 52 Tage vor dem Ostersonntag
            ref: easterX,
            day: -52,
            regions: []
        },
        ROSENMONTAG: {
            nameDE: 'Rosenmontag', // 48 Tage vor dem Ostersonntag
            ref: easterX,
            day: -48,
            regions: []
        },
        FASTNACHTSDIENSTAG: {
            nameDE: 'Fastnachtsdienstag', // 47 Tage vor dem Ostersonntag
            ref: easterX,
            day: -47,
            regions: []
        },
        ASCHERMITTWOCH: {
            nameDE: 'Aschermittwoch', // 46 Tage vor dem Ostersonntag (der erste Tag der Fastenzeit)
            ref: easterX,
            day: -46,
            regions: []
        },
        PALMSONNTAG: {
            nameDE: 'Palmsonntag', // 7 Tage vor dem Ostersonntag
            ref: easterX,
            day: -7,
            regions: []
        },
        GRUENDONNERSTAG: {
            nameDE: 'Gründonnerstag', // 4 Tage vor dem Ostersonntag
            ref: easterX,
            day: -4,
            regions: []
        },
        KARFREITAG: {
            nameDE: 'Karfreitag',
            ref: easterX,
            day: -2,
            regions: allRegions
        },
        OSTERSONNTAG: {
            nameDE: 'Ostersonntag',
            ref: easterX,
            day: 0,
            regions: ['BB', 'ALL']
        },
        OSTERMONTAG: {
            nameDE: 'Ostermontag',
            ref: easterX,
            day: 1,
            regions: allRegions
        },
        JOHANISTAG: {
            nameDE: 'Johannistag', // 30. April
            month: 4,
            day: 24,
            regions: []
        },
        MICHAELISTAG: {
            nameDE: 'Michaelistag', // 30. April
            month: 4,
            day: 29,
            regions: []
        },
        WALPURGISNACHT: {
            nameDE: 'Walpurgisnacht', // 30. April
            month: 4,
            day: 30,
            regions: []
        },
        TAG_DER_ARBEIT: {
            nameDE: 'Tag der Arbeit', // 1. Mai
            nameAlt: 'Maifeiertag',
            month: 1,
            day: 5,
            regions: allRegions
        },
        EISHEILIGEN1: {
            nameDE: 'Eisheiliger Mamertus', // 11. Mai
            month: 5,
            day: 11,
            regions: []
        },
        EISHEILIGEN2: {
            nameDE: 'Eisheiliger Pankratius', // 12. Mai
            month: 5,
            day: 12,
            regions: []
        },
        EISHEILIGEN3: {
            nameDE: 'Eisheiliger Servatius', // 13. Mai
            month: 5,
            day: 13,
            regions: []
        },
        EISHEILIGEN4: {
            nameDE: 'Eisheiliger Bonifatius', // 14. Mai
            month: 5,
            day: 14,
            regions: []
        },
        EISHEILIGEN5: {
            nameDE: 'Eisheilige Kalte Sophie', // 15. Mai
            month: 5,
            day: 15,
            regions: []
        },
        MUTTERTAG: {
            nameDE: 'Muttertag', // 2. Sonntag im Mai
            month: 12 + 5,
            day: 7,
            regions: []
        },
        KINDERTAG: {
            nameDE: 'Kindertag', // 1.6.
            month: 6,
            day: 1,
            regions: []
        },
        CHRISTIHIMMELFAHRT: {
            nameDE: 'Christi Himmelfahrt',
            nameAlt: 'Vatertag',
            ref: easterX,
            day: 39,
            regions: allRegions
        },
        PFINGSTSONNTAG: {
            nameDE: 'Pfingstsonntag',
            ref: easterX,
            day: 49,
            regions: ['BB', 'ALL']
        },
        PFINGSTMONTAG: {
            nameDE: 'Pfingstmontag',
            ref: easterX,
            day: 50,
            regions: allRegions
        },
        TRINITATISSONNTAG: {
            nameDE: 'Trinitatissonntag',
            ref: easterX,
            day: 56,
            regions: []
        },
        FRONLEICHNAM: {
            nameDE: 'Fronleichnam',
            ref: easterX,
            day: 60,
            regions: ['BW', 'HE', 'NW', 'RP', 'SL', 'ALL']
        },
        SIEBENSCHLAEFER: {
            nameDE: 'Siebenschläfer', // 27. Juni
            month: 6,
            day: 27,
            regions: []
        },
        MARIAHIMMELFAHRT: {
            nameDE: 'Mariä Himmelfahrt',
            month: 8,
            day: 15,
            regions: ['SL', 'BY', 'ALL']
        },
        ERNTEDANK: {
            nameDE: 'Erntedank', // erster Sonntag im Oktober
            month: 12 + 10,
            day: 1,
            regions: []
        },
        DEUTSCHEEINHEIT: {
            nameDE: 'Tag der Deutschen Einheit',
            month: 10,
            day: 3,
            regions: allRegions
        },
        REFORMATIONSTAG: {
            nameDE: 'Reformationstag', // 31. Oktober
            nameAlt: 'Halloween',
            month: 10,
            day: 31,
            regions: ['BB', 'MV', 'SN', 'ST', 'TH', 'ALL']
        },
        ALLERHEILIGEN: {
            nameDE: 'Allerheiligen',
            month: 11,
            day: 1,
            regions: ['BW', 'BY', 'NW', 'RP', 'SL', 'ALL']
        },
        ALLERSEELEN: {
            nameDE: 'Allerseelen', // 2. November
            month: 11,
            day: 2,
            regions: []
        },
        MARTINSTAG: {
            nameDE: 'Martinstag', // 11. November
            month: 11,
            day: 11,
            regions: []
        },
        VOLKSTRAUERTAG: {
            nameDE: 'Volkstrauertages', // Sonntag (3 Tage) vor dem Buß- und Bettag
            ref: adventX,
            day: -35,
            regions: []
        },
        BUBETAG: {
            nameDE: 'Buß- und Bettag',
            ref: adventX,
            day: -32,
            regions: ['SN', 'ALL']
        },
        TOTENSONNTAG: {
            nameDE: 'Totensonntag', // Sonntag (4 Tage) nach dem Buß- und Bettag; eine Woche vor dem ersten Advent
            nameAlt: 'Ewigkeitssonntag',
            ref: adventX,
            day: -28,
            regions: []
        },
        ADVENT1: {
            nameDE: 'erste Advent', // vierte Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 1. Advent liegen 11 Tage
            ref: adventX,
            day: -21,
            regions: []
        },
        ADVENT2: {
            nameDE: 'zweite Advent', // dritte Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 2. Advent liegen 18 Tage
            ref: adventX,
            day: -14,
            regions: []
        },
        NIKOLAUS: {
            nameDE: 'Nikolaus', // 6.12.
            month: 12,
            day: 6,
            regions: []
        },
        ADVENT3: {
            nameDE: 'dritte Advent', // zweite Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 3. Advent liegen 25 Tage
            ref: adventX,
            day: -7,
            regions: []
        },
        ADVENT4: {
            nameDE: 'vierte Advent', // Sonntag direkt vor Weihnachten; Zwischen Buss und Bettag und dem 4. Advent liegen 32 Tage
            ref: adventX,
            day: 0,
            regions: []
        },
        HEILIGABEND: {
            nameDE: 'Heiligabend',
            month: 12,
            day: 24,
            regions: []
        },
        ERSTERWEIHNACHTSFEIERTAG: {
            nameDE: '1. Weihnachtstag',
            month: 12,
            day: 25,
            regions: allRegions
        },
        ZWEITERWEIHNACHTSFEIERTAG: {
            nameDE: '2. Weihnachtstag',
            month: 12,
            day: 26,
            regions: allRegions
        },
        SILVESTER: {
            nameDE: 'Silvester', // 31.12.
            month: 12,
            day: 31,
            regions: []
        }
    };

    RED.nodes.registerType('german-holidays', {
        category: 'function',
        defaults: {
            name: {
                value: '',
                required: false
            },
            topic: {
                value: ''
            },
            region: {
                value: '',
                required: false,
                validate: (v) => {
                    return (v === '') || (v === null) || (typeof v === 'undefined');
                }
            },
            holidays: {
                value: []
            },
            specialdays: {
                value: []
            }
        },
        inputs: 1, // set the number of inputs - only 0 or 1
        outputs: 1, // set the number of outputs - 0 to n
        icon: 'default.png', // saved in  icons/myicon.png - myicon.png
        color: '#33cc33',
        label() {
            return this.name || 'Holidays';
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'Holidays',
        oneditprepare() {
            const node = this;

            function _pushUnique(arr, el) {
                const pos = arr.findIndex((x) => {
                    return (el.day === x.day) && (el.month === x.month);
                });
                if (pos > -1) {
                    return;
                }
                arr.push(el);
            }

            function getData(rule) {
                return {
                    id: rule.find('.node-input-item-id').val(),
                    name: rule.find('.node-input-item-name').val(),
                    nameAlt: rule.find('.node-input-item-nameAlt').val(),
                    month: parseInt(rule.find('.node-input-item-month').val()),
                    day: parseInt(rule.find('.node-input-item-day').val())
                };
            }

            function saveHolidays() {
                console.log('saveHolidays');
                node.holidays = [];
                const holidays = $('#node-input-holiday-container').editableList('items');
                holidays.each(function (_i) {
                    const rule = $(this);
                    node.holidays.push(getData(rule));
                });
                console.log(node.holidays);
            }

            function loadHolidays() {
                console.log('addHolidays');
                console.log(node.holidays);
                if (node.holidays) {
                    node.holidays.forEach((item) => {
                        $('#node-input-holiday-container').editableList('addItem', item);
                    });
                }
            }

            function saveSpecialdays() {
                console.log('saveSpecialdays');
                node.specialdays = [];
                const specialdays = $('#node-input-specialday-container').editableList('items');
                specialdays.each(function (_i) {
                    const rule = $(this);
                    node.specialdays.push(getData(rule));
                });
                console.log(node.specialdays);
            }

            function loadSpecialdays() {
                console.log('loadSpecialdays');
                console.log(node.specialdays);
                if (node.specialdays) {
                    node.specialdays.forEach((item) => {
                        $('#node-input-specialday-container').editableList('addItem', item);
                    });
                }
            }

            function addHolidays(region) {
                console.log('addHolidays');
                saveHolidays();

                Object.keys(allDaysDefinition).forEach((key) => {
                    const d = allDaysDefinition[key];
                    if (d.regions.includes(region)) {
                        _pushUnique(node.holidays, {
                            id: key,
                            name : d.nameDE,
                            month: d.month || d.ref,
                            day: d.day
                        });
                    }
                });

                loadHolidays();
            }

            function addSpecialdays() {
                console.log('addSpecialdays');
                saveHolidays();
                saveSpecialdays();

                Object.keys(allDaysDefinition).forEach((key) => {
                    const d = allDaysDefinition[key];
                    const obj = {
                        id: key,
                        name: d.nameDE,
                        month: d.month || d.ref,
                        day: d.day
                    };
                    if (!node.holidays.some(e => (e.month === obj.month && e.day === obj.day))) {
                        _pushUnique(node.specialdays, obj);
                    }
                });

                loadSpecialdays();
            }

            function checkSpecialdays() {
                console.log('checkSpecialdays');
                const $addSpecialdayBtn = $('#node-button-addSpecialdayBtn');
                const length = $('#node-input-specialday-container').editableList('length');
                if (length <=0 ) {
                    $addSpecialdayBtn.hide();
                } else {
                    $addSpecialdayBtn.show();
                }
            }

            // #region container generic
            function edtLstResizeItem(row) {
                const newWidth = row.width() - 10;
                const $name = row.find('.node-input-item-name');
                const $month = row.find('.node-input-item-month');
                const $day = row.find('.node-input-item-day');
                const $btn = row.find('.node-button-item-edit');
                // row1
                $month.width(50);
                $day.width(50);
                const btnWidth = $btn.width();
                $name.width(newWidth - 165 - btnWidth);
            }

            function edtLstAddItem(containerRow, containerIndex, data) {
                containerRow.css({ overflow: 'hidden', whiteSpace: 'nowrap' });
                const row = $('<div/>').appendTo(containerRow);
                const id = (data.id || '');
                // row1
                // id
                $('<input/>', {
                    class: 'node-input-item-id',
                    id: 'node-input-item-id' + containerIndex,
                    type: 'hidden',
                    value: id
                }).appendTo(row);
                // name
                const $name = $('<input/>', {
                    class: 'node-input-item-name',
                    id: 'node-input-item-name' + containerIndex,
                    type: 'text',
                    value: (data.name || ''),
                    title: (id !== '') ?  node._('german-holidays.placeholder.namePreDefined') : node._('german-holidays.placeholder.name'),
                    placeholder: node._('german-holidays.placeholder.name')
                }).appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-namealt',
                    id: 'node-input-item-namealt' + containerIndex,
                    type: 'hidden',
                    value: (data.nameAlt || '')
                }).appendTo(row);
                // month
                const $month = $('<select/>', {
                    class: 'node-input-item-month',
                    id: 'node-input-item-month' + containerIndex,
                    title: node._('german-holidays.placeholder.month')
                });
                $month.appendTo(row);
                for (let index = 1; index <= 12; index++) {
                    $month.append($('<option></option>').val(index).text(node._('german-holidays.month.' + String(index + 11))));
                }
                $month.append($('<option></option>').val(-1).text(node._('german-holidays.label.relEaster')));
                $month.append($('<option></option>').val(-2).text(node._('german-holidays.label.rel4ThAdvent')));
                for (let index = 0; index <= 11; index++) {
                    $month.append($('<option></option>').val(index + 13).text(node._('german-holidays.relday.' + String(index))));
                }

                // day
                const $day = $('<input/>', {
                    class: 'node-input-item-day',
                    id: 'node-input-item-day' + containerIndex,
                    type: 'number',
                    min: 1,
                    max: 31,
                    step: 1,
                    title: node._('german-holidays.placeholder.day'),
                    placeholder: node._('german-holidays.placeholder.day')
                });
                $day.appendTo(row);
                // edit Button
                // <a id="node-config-lookup-ipaddress" class="btn"><i id="node-config-lookup-ipaddress-icon" class="fa fa-search"></i></a>
                const $btn = $('<a />', {
                    class: 'node-button-item-edit btn ui-button ui-widget ui-corner-all',
                    id: 'node-button-item-edit' + containerIndex
                }).append('<i class= "fa fa-plus" >').appendTo(row);
                // set day
                $month.change(() => {
                    const month = $month.val();
                    if (month >= 1 && month <= 12) {
                        $day.attr({
                            'max' : 31,
                            'min' : 1
                        });
                    } else if (month >= 13 && month <= 24) {
                        $day.attr({
                            'max' : 31,
                            'min' : 1
                        });
                    } else if (month < 1) {
                        $day.attr({
                            'max' : 370,
                            'min' : -370
                        });
                    }
                });
                $month.val(data.month || 1);
                $month.change();
                $day.val(data.month || 1);
                if (id !== '') {
                    $name.prop( 'disabled', true );
                }

                $btn.click(() => {
                    dialogLoadData(row);
                });

                edtLstResizeItem(containerRow);
                checkSpecialdays();
            }
            // #endregion container generic
            // #region holiday-container
            $('#node-input-holiday-container').css('min-height', '200px').css('min-width', '200px').editableList({
                addItem: edtLstAddItem,
                sortItems(holidays) {
                    holidays = $('#node-input-holiday-container').editableList('items');
                    holidays.each(function (i) {
                        $(this).find('.node-input-holiday-index').html(i + 1);
                    });
                },
                resizeItem: edtLstResizeItem,
                removeItem: () => {
                    checkSpecialdays();
                },
                sortable: true,
                removable: true
            });
            // #endregion holiday-container
            // #region specialday-container
            $('#node-input-specialday-container').css('min-height', '200px').css('min-width', '200px').editableList({
                addItem: edtLstAddItem,
                resizeItem: edtLstResizeItem,
                sortable: true,
                removable: true
            });
            // #endregion specialday-container

            // #region migrate
            const oldValue = $('#node-input-regon').val();
            if (oldValue && oldValue !== '') {
                // Backward compatibility
                addHolidays(oldValue);
                $('#node-input-regon').val('');
            }
            // #endregion migrate

            // #region dialog
            let $dialogConnFields = {};
            const $dialogId = $('#dialog-input-id');
            const $dialogName = $('#dialog-input-name');
            const $dialogNameAlt = $('#dialog-input-nameAlt');
            const $dialogTyp = $('#dialog-input-typ');
            const $dialogDate = $('#dialog-input-date');
            const $dialogMonth = $('#dialog-input-month');
            const $dialogOffset = $('#dialog-input-offset');
            const $dialogDaysRel = $('#dialog-input-daysRel');

            function dialogLoadData(rule) {
                console.log('dialogLoadData');
                $dialogConnFields = rule;
                $dialogId.val(rule.find('.node-input-item-id').val());
                $dialogName.val(rule.find('.node-input-item-name').val());
                $dialogNameAlt.val(rule.find('.node-input-item-nameAlt').val());
                const month = parseInt(rule.find('.node-input-item-month').val());
                const day = parseInt(rule.find('.node-input-item-day').val());
                $dialogDate.datepicker('setDate', null);
                $dialogMonth.val('1');
                $dialogOffset.val('1');
                $dialogDaysRel.val('1');

                console.log(month);
                console.log(day);
                if (month >= 1 && month <= 12) {
                    $dialogTyp.val('date');
                    const date = new Date();
                    date.setUTCHours(0,0,0,0);
                    date.setUTCMonth(month - 1,day);
                    console.log(date);
                    $dialogDate.datepicker('setDate', date);
                } else if (month >= 13 && month <= 24) {
                    $dialogTyp.val('weekday');
                    $dialogMonth.val(month - 12);
                    $dialogOffset.val(day);
                } else if (month === -1) {
                    $dialogTyp.val('easter');
                    $dialogDaysRel.val(day);
                } else if (month === -2) {
                    $dialogTyp.val('advent');
                    $dialogDaysRel.val(day);
                } else {
                    $dialogTyp.val('date');
                    $dialogDate.datepicker('setDate', null);
                }
                $dialogTyp.change();
                $dialog.dialog('open');
            }

            function dialogSaveData() {
                console.log('dialogSaveData');

                $dialogConnFields.find('.node-input-item-id').val($dialogId.val());
                $dialogConnFields.find('.node-input-item-name').val($dialogName.val());
                $dialogConnFields.find('.node-input-item-nameAlt').val($dialogNameAlt.val());
                switch ($dialogTyp.val()) {
                    case 'easter':
                        $dialogConnFields.find('.node-input-item-month').val('-1');
                        $dialogConnFields.find('.node-input-item-day').val($dialogDaysRel.val());
                        break;
                    case 'advent':
                        $dialogConnFields.find('.node-input-item-month').val('-2');
                        $dialogConnFields.find('.node-input-item-day').val($dialogDaysRel.val());
                        break;
                    case 'weekday':
                        $dialogConnFields.find('.node-input-item-month').val($dialogMonth.val() + 12);
                        $dialogConnFields.find('.node-input-item-day').val($dialogOffset.val());
                        break;
                    default: {
                        const date = $dialogDate.datepicker( 'getDate' );
                        if (date !== null) {
                            $dialogConnFields.find('.node-input-item-month').val(date.getUTCMonth() + 1);
                            $dialogConnFields.find('.node-input-item-day').val(date.getUTCDate());
                        }
                    }
                }
                $dialog.dialog( 'close' );
            }

            $dialogDate.datepicker({
                dateFormat: 'MM d (mm-dd)',
                showOtherMonths: true,
                selectOtherMonths: true,
                changeMonth: true,
                changeYear: false,
                showButtonPanel: true
            });

            for (let index = 1; index <= 12; index++) {
                $dialogMonth.append($('<option></option>').val(index).text(node._('german-holidays.month.' + String(index + 11))));
            }

            $dialogTyp.change(() => {
                switch ($dialogTyp.val()) {
                    case 'easter':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-offset-row').hide();
                        $('.dialog-input-daysRel-row').show();
                        break;
                    case 'advent':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-offset-row').hide();
                        $('.dialog-input-daysRel-row').show();
                        break;
                    case 'weekday':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').show();
                        $('.dialog-input-offset-row').show();
                        $('.dialog-input-daysRel-row').hide();
                        break;
                    default:
                        $('.dialog-input-date-row').show();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-offset-row').hide();
                        $('.dialog-input-daysRel-row').hide();
                }
            });

            const $dialog = $('#dialog-edit-day').dialog({
                autoOpen: false,
                height: 450,
                width: 530,
                modal: true,
                buttons: {
                    Ok: dialogSaveData,
                    Cancel: function() {
                        $dialog.dialog( 'close' );
                    }
                },
                close: function() {
                    // document.forms["dialog-edit-day-form"].reset();
                    // $dialogForm[0].reset();
                }
            });

            const $dialogForm = $dialog.find( 'form' );
            $dialogForm.on( 'submit', ( event ) => {
                event.preventDefault();
                dialogSaveData();
            });

            // #endregion dialog

            // #region Button
            console.log('initialize button?');

            const $addHoliday = $('#node-button-addHolidays');
            $addHoliday.click(() => {
                console.log('$addHoliday.click');
                addHolidays($('#node-regionSel').val());
                $dialog.dialog('close');
            });

            const $clearHolidayBtn = $('#node-button-clearHolidayBtn');
            $clearHolidayBtn.click(() => {
                console.log('$clearHolidayBtn.click');
                $('#node-input-holiday-container').editableList('empty');
            });

            const $addSpecialdayBtn = $('#node-button-addSpecialDays');
            $addSpecialdayBtn.click(() => {
                console.log('$addSpecialdayBtn.click');
                addSpecialdays();
                $dialog.dialog('close');
            });

            const $clearSpecialdayBtn = $('#node-button-clearSpecialdayBtn');
            $clearSpecialdayBtn.click(() => {
                console.log('$clearSpecialdayBtn.click');
                $('#node-input-specialday-container').editableList('empty');
            });
            // #endregion Button

            // #region load data
            loadHolidays();
            loadSpecialdays();
            // #endregion load data
        },
        oneditsave() {
            const node = this;
            function getData(rule) {
                return {
                    id: rule.find('.node-input-item-id').val(),
                    name: rule.find('.node-input-item-name').val(),
                    nameAlt: rule.find('.node-input-item-nameAlt').val(),
                    month: parseInt(rule.find('.node-input-item-month').val()),
                    day: parseInt(rule.find('.node-input-item-day').val())
                };
            }
            // #region holiday-container
            node.holidays = [];
            const holidays = $('#node-input-holiday-container').editableList('items');
            holidays.each(function (_i) {
                const rule = $(this);
                node.holidays.push(getData(rule));
            });
            // #endregion holiday-container
            // #region specialday-container
            node.specialdays = [];
            const specialdays = $('#node-input-specialday-container').editableList('items');
            specialdays.each(function (_i) {
                const rule = $(this);
                node.specialdays.push(getData(rule));
            });
            // #endregion specialday-container
        }
    });</script>